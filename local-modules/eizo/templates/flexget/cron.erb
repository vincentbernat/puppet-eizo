#!/bin/zsh

flexget="<%= @home %>/venv/bin/flexget"
from="<%= @move_from %>"
to="<%= @move_to %>"

# Simple wrappers around flexget that could run in a crontab.

setopt extendedglob

case $1 in
    run)
        (${flexget} --cron execute 3>&1 1>&2 2>&3 | \
             grep -v InsecureRequestWarning) 3>&1 1>&2 2>&3
        :
        ;;
    move)
        cd $from
        for f in **/*.{mkv,avi,mp4}(NL+100M) **/*.srt(N); do
            target=$to/${f%%/*}
            [[ ! -d $target ]] || mv $f $target/.
        done
        rm -f **/*.{txt,nfo,jpg}(N)
        for d in **/*(N/^F); do
            rmdir $d
        done
        ;;
esac
