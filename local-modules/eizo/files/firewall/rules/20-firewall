# -*- sh -*-

# Rules when the firewall is the source.

ip46tables -N FIREWALL-OUTPUT
ip46tables -A OUTPUT -j FIREWALL-OUTPUT

icmp FIREWALL-OUTPUT 50

# Can emit DHCP requests
iptables -A FIREWALL-OUTPUT -p udp --source-port bootpc --destination-port bootps -o internet -j ACCEPT

# Can answer to DHCP requests and DNS (dunno why the conntrack doesn't catch this)
for iface in $lans; do
    iptables   -A FIREWALL-OUTPUT -p udp --source-port bootps --destination-port bootpc -o $iface -j ACCEPT
    ip6tables  -A FIREWALL-OUTPUT -p udp --source-port dhcpv6-server --destination-port dhcpv6-client -o $iface -j ACCEPT
    ip46tables -A FIREWALL-OUTPUT -p udp --source-port domain --destination-port domain -o $iface -j ACCEPT
done

# Can emit router advertisements
for iface in $lans; do
    ip6tables -A FIREWALL-OUTPUT -p icmpv6 --icmpv6-type router-advertisement -j ACCEPT
done

# Can do mdns
ip46tables -A FIREWALL-OUTPUT -p udp --dport mdns -o lan-trusted -j ACCEPT
# But not on others
ip46tables -A FIREWALL-OUTPUT -p udp --dport mdns -o lan-guest -j DROP
ip46tables -A FIREWALL-OUTPUT -p udp --dport mdns -o wlan-guest -j DROP

# 6rd
iptables -A FIREWALL-OUTPUT -p ipv6 -j ACCEPT

# Some users have unlimited Internet access, except port 25
ip46tables -N FIREWALL-OUTPUT-INET
ip46tables -A FIREWALL-OUTPUT-INET -p tcp --dport smtp -j RETURN
ip46tables -A FIREWALL-OUTPUT-INET -j ACCEPT
for user in debian-transmission bernat; do
    ip46tables -A FIREWALL-OUTPUT -o internet -m owner --uid-owner $user -j FIREWALL-OUTPUT-INET
done

# Some may access special ports
for userport in \
    ntp:udp/ntp root:udp/ntp \
    root:tcp/http root:tcp/https \
    xbmc:tcp/http xbmc:tcp/https \
    postfix:tcp/submission \
    www-data:udp/domain \
    unbound:udp/domain unbound:tcp/domain \
    flexget:tcp/http flexget:tcp/https; do

    ip46tables -A FIREWALL-OUTPUT -o internet \
        -m owner --uid-owner ${userport%:*} \
        -p ${${userport#*:}%/*} --dport ${${userport#*:}#*/} \
        -j ACCEPT
done

reject FIREWALL-OUTPUT
