# -*- sh -*-

main sysctl -qw net.core.default_qdisc=fq_codel

for iface in /sys/class/net/*; do
    [[ ${iface##*/} != "lo" ]] || continue
    [[ $(<$iface/tx_queue_len) != 0 ]] || continue
    [[ $(<$iface/iflink) = $(<$iface/ifindex) ]] || continue

    main ip link set txqueuelen 32 dev ${iface##*/}
    main tc qdisc replace dev ${iface##*/} root fq_codel
done

# With 1GB links, it seems pointless to do any complex QoS.

# For Orange, we need to tweak a bit QoS. DHCP requests should be CS6
# but ISC DHCP client is using raw socket and this bypass iptables.
# Therefore, we use tc to set the appropriate priority that will be
# copied as 802.1p priority.
main tc filter add dev internet parent 0: prio 1 protocol ip u32 \
     match ip protocol 17 \
     match ip dport 67 \
     skbedit priority 0:6
# ARP
main tc filter add dev internet parent 0: prio 1 protocol 0x806 u32 \
     match u32 0 0 \
     skbedit priority 0:6
# IGMP
main tc filter add dev internet parent 0: prio 1 protocol ip u32 \
     match ip protocol 2 \
     skbedit priority 0:6
# ICMP
main tc filter add dev internet parent 0: prio 1 protocol ip u32 \
     match ip protocol 1 \
     skbedit priority 0:6

# Same for IPv6
main tc filter add dev internet parent 0: prio 1 protocol ip6 u32 \
     match ip6 protocol 17 \
     match ip6 dport 547 \
     skbedit priority 0:6
# ICMP
main tc filter add dev internet parent 0: prio 1 protocol ip6 u32 \
     match ip6 protocol 58 \
     skbedit priority 0:6
