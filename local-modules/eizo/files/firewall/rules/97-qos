# -*- sh -*-

main sysctl -qw net.core.default_qdisc=fq_codel
for iface in /sys/class/net/*; do
    [[ ${iface##*/} != "lo" ]] || continue
    [[ $(<$iface/tx_queue_len) != 0 ]] || continue
    [[ $(<$iface/iflink) = $(<$iface/ifindex) ]] || continue

    main ip link set txqueuelen 32 dev ${iface##*/}
    # A bit odd, but we just want to apply the default qdisc. We can
    # only delete the current qdisc if it is not the default.
    main tc qdisc replace dev ${iface##*/} root fq_codel
    main tc qdisc del dev ${iface##*/} root
done

# We stole CeroWRT stuff for QoS
main (
    export IFACE=internet
    export UPLINK=2302
    export DOWNLINK=14698
    export INSMOD=modprobe
    ./qos/simple.qos
)
